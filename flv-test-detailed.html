<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLV Test - Detailed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    video {
      width: 100%;
      max-width: 800px;
      background: #000;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #666;
      padding-left: 10px;
    }
    .log-entry.info { border-color: #4CAF50; color: #4CAF50; }
    .log-entry.error { border-color: #f44336; color: #f44336; }
    .log-entry.warn { border-color: #ff9800; color: #ff9800; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px;
      font-weight: bold;
    }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>ğŸ¬ FLV æ’­æ”¾æµ‹è¯• - è¯¦ç»†è¯Šæ–­</h1>
  
  <div class="section">
    <h2>è§†é¢‘æ’­æ”¾å™¨</h2>
    <video id="videoElement" controls></video>
    <div style="margin-top: 10px;">
      <span id="status" class="status loading">æœªåŠ è½½</span>
    </div>
    <div style="margin-top: 10px;">
      <button onclick="loadVideo()">ğŸ”„ é‡æ–°åŠ è½½</button>
      <button onclick="playVideo()" id="playBtn" disabled>â–¶ï¸ æ’­æ”¾</button>
      <button onclick="pauseVideo()" id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
      <button onclick="testCORS()">ğŸ§ª æµ‹è¯•CORS</button>
      <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
    </div>
  </div>

  <div class="section">
    <h2>è¯Šæ–­ä¿¡æ¯</h2>
    <div id="diagnostics"></div>
  </div>

  <div class="section">
    <h2>ğŸ“‹ æ—¥å¿—</h2>
    <div id="log" class="log"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
  <script>
    const videoUrl = 'https://srs-tsport.sgp1.cdn.digitaloceanspaces.com/dvr/live/stream_7_68fa0d1b38d61/1761294005465.flv';
    let flvPlayer = null;
    let videoElement = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function setStatus(text, type) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = `status ${type}`;
    }

    function updateDiagnostics() {
      const diag = document.getElementById('diagnostics');
      diag.innerHTML = `
        <p><strong>flv.js ç‰ˆæœ¬:</strong> ${flvjs.version || 'Unknown'}</p>
        <p><strong>flv.js æ”¯æŒ:</strong> ${flvjs.isSupported() ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>
        <p><strong>æµè§ˆå™¨:</strong> ${navigator.userAgent}</p>
        <p><strong>è§†é¢‘URL:</strong> <code>${videoUrl}</code></p>
        <p><strong>æ’­æ”¾å™¨çŠ¶æ€:</strong> ${flvPlayer ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</p>
      `;
    }

    async function testCORS() {
      log('å¼€å§‹æµ‹è¯•CORSé…ç½®...', 'info');
      
      try {
        const response = await fetch(videoUrl, { 
          method: 'HEAD',
          mode: 'cors'
        });
        
        log(`HTTPçŠ¶æ€: ${response.status} ${response.statusText}`, 'info');
        
        const corsHeader = response.headers.get('access-control-allow-origin');
        if (corsHeader) {
          log(`âœ… CORSé…ç½®æ­£ç¡®: ${corsHeader}`, 'info');
          log('æ–‡ä»¶å¤§å°: ' + response.headers.get('content-length') + ' bytes', 'info');
          log('å†…å®¹ç±»å‹: ' + response.headers.get('content-type'), 'info');
        } else {
          log('âŒ æœªæ£€æµ‹åˆ°CORSå¤´! éœ€è¦é…ç½®CORS', 'error');
        }
      } catch (error) {
        log(`âŒ CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        log('è¯·æ£€æŸ¥: 1) URLæ˜¯å¦æ­£ç¡® 2) CORSæ˜¯å¦é…ç½® 3) æ–‡ä»¶æ˜¯å¦å­˜åœ¨', 'error');
      }
    }

    function loadVideo() {
      log('=== å¼€å§‹åŠ è½½è§†é¢‘ ===', 'info');
      setStatus('åŠ è½½ä¸­...', 'loading');

      // æ¸…ç†æ—§çš„æ’­æ”¾å™¨
      if (flvPlayer) {
        log('æ¸…ç†æ—§æ’­æ”¾å™¨...', 'info');
        try {
          flvPlayer.pause();
          flvPlayer.unload();
          flvPlayer.detachMediaElement();
          flvPlayer.destroy();
        } catch (e) {
          log('æ¸…ç†æ’­æ”¾å™¨æ—¶å‡ºé”™: ' + e.message, 'warn');
        }
        flvPlayer = null;
      }

      videoElement = document.getElementById('videoElement');

      if (!flvjs.isSupported()) {
        log('âŒ æµè§ˆå™¨ä¸æ”¯æŒflv.js', 'error');
        setStatus('ä¸æ”¯æŒ', 'error');
        return;
      }

      log('åˆ›å»ºflv.jsæ’­æ”¾å™¨...', 'info');
      log(`é…ç½®: isLive=false, enableWorker=true`, 'info');

      flvPlayer = flvjs.createPlayer({
        type: 'flv',
        url: videoUrl,
        isLive: false,
        hasAudio: true,
        hasVideo: true,
        enableWorker: true,
        enableStashBuffer: true,
        stashInitialSize: 128,
        autoCleanupSourceBuffer: true
      }, {
        enableWorker: true,
        enableStashBuffer: true,
        lazyLoad: false,
        lazyLoadMaxDuration: 3 * 60,
        seekType: 'range'
      });

      // ç»‘å®šäº‹ä»¶
      flvPlayer.on(flvjs.Events.ERROR, (errorType, errorDetail, errorInfo) => {
        log(`âŒ æ’­æ”¾å™¨é”™è¯¯: ${errorType} - ${errorDetail}`, 'error');
        if (errorInfo) {
          log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(errorInfo)}`, 'error');
        }
        setStatus('é”™è¯¯', 'error');
        
        // è¯¦ç»†çš„é”™è¯¯åˆ†æ
        if (errorType === flvjs.ErrorTypes.NETWORK_ERROR) {
          log('ç½‘ç»œé”™è¯¯ - å¯èƒ½æ˜¯CORSã€URLé”™è¯¯æˆ–æ–‡ä»¶ä¸å­˜åœ¨', 'error');
        } else if (errorType === flvjs.ErrorTypes.MEDIA_ERROR) {
          log('åª’ä½“é”™è¯¯ - å¯èƒ½æ˜¯æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ”¯æŒ', 'error');
        }
      });

      flvPlayer.on(flvjs.Events.LOADING_COMPLETE, () => {
        log('âœ… è§†é¢‘åŠ è½½å®Œæˆ', 'info');
      });

      flvPlayer.on(flvjs.Events.RECOVERED_EARLY_EOF, () => {
        log('âš ï¸ ä»EOFé”™è¯¯æ¢å¤', 'warn');
      });

      flvPlayer.on(flvjs.Events.MEDIA_INFO, (mediaInfo) => {
        log('ğŸ“Š åª’ä½“ä¿¡æ¯:', 'info');
        log(`  åˆ†è¾¨ç‡: ${mediaInfo.width}x${mediaInfo.height}`, 'info');
        log(`  æ—¶é•¿: ${mediaInfo.duration}ç§’`, 'info');
        log(`  è§†é¢‘ç¼–ç : ${mediaInfo.videoCodec}`, 'info');
        log(`  éŸ³é¢‘ç¼–ç : ${mediaInfo.audioCodec}`, 'info');
      });

      flvPlayer.on(flvjs.Events.STATISTICS_INFO, (stats) => {
        // å®šæœŸç»Ÿè®¡ä¿¡æ¯ï¼ˆæ³¨é‡Šæ‰ä»¥å‡å°‘æ—¥å¿—ï¼‰
        // log(`ç»Ÿè®¡: é€Ÿåº¦=${stats.speed}KB/s, ä¸¢å¸§=${stats.droppedFrames}`, 'info');
      });

      // è§†é¢‘å…ƒç´ äº‹ä»¶
      videoElement.onloadedmetadata = () => {
        log('âœ… è§†é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆ', 'info');
        log(`æ—¶é•¿: ${videoElement.duration}ç§’`, 'info');
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = false;
      };

      videoElement.oncanplay = () => {
        log('âœ… è§†é¢‘å¯ä»¥æ’­æ”¾', 'info');
        setStatus('å°±ç»ª', 'success');
      };

      videoElement.onplay = () => {
        log('â–¶ï¸ æ’­æ”¾å¼€å§‹', 'info');
        setStatus('æ’­æ”¾ä¸­', 'success');
      };

      videoElement.onpause = () => {
        log('â¸ï¸ æ’­æ”¾æš‚åœ', 'info');
        setStatus('å·²æš‚åœ', 'loading');
      };

      videoElement.onerror = (e) => {
        log(`âŒ è§†é¢‘å…ƒç´ é”™è¯¯: ${e.target.error?.message || 'Unknown'}`, 'error');
        setStatus('é”™è¯¯', 'error');
      };

      // é™„åŠ åˆ°è§†é¢‘å…ƒç´ 
      log('é™„åŠ æ’­æ”¾å™¨åˆ°è§†é¢‘å…ƒç´ ...', 'info');
      flvPlayer.attachMediaElement(videoElement);

      // åŠ è½½è§†é¢‘
      log('å¼€å§‹åŠ è½½FLVæµ...', 'info');
      try {
        flvPlayer.load();
        log('âœ… load()è°ƒç”¨æˆåŠŸ', 'info');
      } catch (e) {
        log(`âŒ load()å¤±è´¥: ${e.message}`, 'error');
        setStatus('åŠ è½½å¤±è´¥', 'error');
      }

      updateDiagnostics();
    }

    function playVideo() {
      if (videoElement) {
        videoElement.play().then(() => {
          log('æ’­æ”¾å‘½ä»¤æ‰§è¡ŒæˆåŠŸ', 'info');
        }).catch(e => {
          log(`æ’­æ”¾å¤±è´¥: ${e.message}`, 'error');
        });
      }
    }

    function pauseVideo() {
      if (videoElement) {
        videoElement.pause();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', () => {
      log('=== é¡µé¢åŠ è½½å®Œæˆ ===', 'info');
      log(`flv.jsç‰ˆæœ¬: ${flvjs.version}`, 'info');
      log(`æµè§ˆå™¨æ”¯æŒ: ${flvjs.isSupported() ? 'æ˜¯' : 'å¦'}`, 'info');
      updateDiagnostics();
      
      // è‡ªåŠ¨æµ‹è¯•CORS
      setTimeout(() => {
        testCORS();
      }, 500);
      
      // è‡ªåŠ¨åŠ è½½è§†é¢‘
      setTimeout(() => {
        loadVideo();
      }, 1000);
    });

    // æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (flvPlayer) {
        flvPlayer.destroy();
      }
    });
  </script>
</body>
</html>
