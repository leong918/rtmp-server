<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FLV Test - Detailed</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    video {
      width: 100%;
      max-width: 800px;
      background: #000;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #666;
      padding-left: 10px;
    }
    .log-entry.info { border-color: #4CAF50; color: #4CAF50; }
    .log-entry.error { border-color: #f44336; color: #f44336; }
    .log-entry.warn { border-color: #ff9800; color: #ff9800; }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover { background: #0056b3; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 4px;
      margin: 5px;
      font-weight: bold;
    }
    .status.loading { background: #fff3cd; color: #856404; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>🎬 FLV 播放测试 - 详细诊断</h1>
  
  <div class="section">
    <h2>视频播放器</h2>
    <video id="videoElement" controls></video>
    <div style="margin-top: 10px;">
      <span id="status" class="status loading">未加载</span>
    </div>
    <div style="margin-top: 10px;">
      <button onclick="loadVideo()">🔄 重新加载</button>
      <button onclick="playVideo()" id="playBtn" disabled>▶️ 播放</button>
      <button onclick="pauseVideo()" id="pauseBtn" disabled>⏸️ 暂停</button>
      <button onclick="testCORS()">🧪 测试CORS</button>
      <button onclick="clearLog()">🗑️ 清除日志</button>
    </div>
  </div>

  <div class="section">
    <h2>诊断信息</h2>
    <div id="diagnostics"></div>
  </div>

  <div class="section">
    <h2>📋 日志</h2>
    <div id="log" class="log"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
  <script>
    const videoUrl = 'https://srs-tsport.sgp1.cdn.digitaloceanspaces.com/dvr/live/stream_7_68fa0d1b38d61/1761294005465.flv';
    let flvPlayer = null;
    let videoElement = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type}] ${message}`);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    function setStatus(text, type) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = `status ${type}`;
    }

    function updateDiagnostics() {
      const diag = document.getElementById('diagnostics');
      diag.innerHTML = `
        <p><strong>flv.js 版本:</strong> ${flvjs.version || 'Unknown'}</p>
        <p><strong>flv.js 支持:</strong> ${flvjs.isSupported() ? '✅ 是' : '❌ 否'}</p>
        <p><strong>浏览器:</strong> ${navigator.userAgent}</p>
        <p><strong>视频URL:</strong> <code>${videoUrl}</code></p>
        <p><strong>播放器状态:</strong> ${flvPlayer ? '已初始化' : '未初始化'}</p>
      `;
    }

    async function testCORS() {
      log('开始测试CORS配置...', 'info');
      
      try {
        const response = await fetch(videoUrl, { 
          method: 'HEAD',
          mode: 'cors'
        });
        
        log(`HTTP状态: ${response.status} ${response.statusText}`, 'info');
        
        const corsHeader = response.headers.get('access-control-allow-origin');
        if (corsHeader) {
          log(`✅ CORS配置正确: ${corsHeader}`, 'info');
          log('文件大小: ' + response.headers.get('content-length') + ' bytes', 'info');
          log('内容类型: ' + response.headers.get('content-type'), 'info');
        } else {
          log('❌ 未检测到CORS头! 需要配置CORS', 'error');
        }
      } catch (error) {
        log(`❌ CORS测试失败: ${error.message}`, 'error');
        log('请检查: 1) URL是否正确 2) CORS是否配置 3) 文件是否存在', 'error');
      }
    }

    function loadVideo() {
      log('=== 开始加载视频 ===', 'info');
      setStatus('加载中...', 'loading');

      // 清理旧的播放器
      if (flvPlayer) {
        log('清理旧播放器...', 'info');
        try {
          flvPlayer.pause();
          flvPlayer.unload();
          flvPlayer.detachMediaElement();
          flvPlayer.destroy();
        } catch (e) {
          log('清理播放器时出错: ' + e.message, 'warn');
        }
        flvPlayer = null;
      }

      videoElement = document.getElementById('videoElement');

      if (!flvjs.isSupported()) {
        log('❌ 浏览器不支持flv.js', 'error');
        setStatus('不支持', 'error');
        return;
      }

      log('创建flv.js播放器...', 'info');
      log(`配置: isLive=false, enableWorker=true`, 'info');

      flvPlayer = flvjs.createPlayer({
        type: 'flv',
        url: videoUrl,
        isLive: false,
        hasAudio: true,
        hasVideo: true,
        enableWorker: true,
        enableStashBuffer: true,
        stashInitialSize: 128,
        autoCleanupSourceBuffer: true
      }, {
        enableWorker: true,
        enableStashBuffer: true,
        lazyLoad: false,
        lazyLoadMaxDuration: 3 * 60,
        seekType: 'range'
      });

      // 绑定事件
      flvPlayer.on(flvjs.Events.ERROR, (errorType, errorDetail, errorInfo) => {
        log(`❌ 播放器错误: ${errorType} - ${errorDetail}`, 'error');
        if (errorInfo) {
          log(`错误详情: ${JSON.stringify(errorInfo)}`, 'error');
        }
        setStatus('错误', 'error');
        
        // 详细的错误分析
        if (errorType === flvjs.ErrorTypes.NETWORK_ERROR) {
          log('网络错误 - 可能是CORS、URL错误或文件不存在', 'error');
        } else if (errorType === flvjs.ErrorTypes.MEDIA_ERROR) {
          log('媒体错误 - 可能是文件损坏或格式不支持', 'error');
        }
      });

      flvPlayer.on(flvjs.Events.LOADING_COMPLETE, () => {
        log('✅ 视频加载完成', 'info');
      });

      flvPlayer.on(flvjs.Events.RECOVERED_EARLY_EOF, () => {
        log('⚠️ 从EOF错误恢复', 'warn');
      });

      flvPlayer.on(flvjs.Events.MEDIA_INFO, (mediaInfo) => {
        log('📊 媒体信息:', 'info');
        log(`  分辨率: ${mediaInfo.width}x${mediaInfo.height}`, 'info');
        log(`  时长: ${mediaInfo.duration}秒`, 'info');
        log(`  视频编码: ${mediaInfo.videoCodec}`, 'info');
        log(`  音频编码: ${mediaInfo.audioCodec}`, 'info');
      });

      flvPlayer.on(flvjs.Events.STATISTICS_INFO, (stats) => {
        // 定期统计信息（注释掉以减少日志）
        // log(`统计: 速度=${stats.speed}KB/s, 丢帧=${stats.droppedFrames}`, 'info');
      });

      // 视频元素事件
      videoElement.onloadedmetadata = () => {
        log('✅ 视频元数据加载完成', 'info');
        log(`时长: ${videoElement.duration}秒`, 'info');
        document.getElementById('playBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = false;
      };

      videoElement.oncanplay = () => {
        log('✅ 视频可以播放', 'info');
        setStatus('就绪', 'success');
      };

      videoElement.onplay = () => {
        log('▶️ 播放开始', 'info');
        setStatus('播放中', 'success');
      };

      videoElement.onpause = () => {
        log('⏸️ 播放暂停', 'info');
        setStatus('已暂停', 'loading');
      };

      videoElement.onerror = (e) => {
        log(`❌ 视频元素错误: ${e.target.error?.message || 'Unknown'}`, 'error');
        setStatus('错误', 'error');
      };

      // 附加到视频元素
      log('附加播放器到视频元素...', 'info');
      flvPlayer.attachMediaElement(videoElement);

      // 加载视频
      log('开始加载FLV流...', 'info');
      try {
        flvPlayer.load();
        log('✅ load()调用成功', 'info');
      } catch (e) {
        log(`❌ load()失败: ${e.message}`, 'error');
        setStatus('加载失败', 'error');
      }

      updateDiagnostics();
    }

    function playVideo() {
      if (videoElement) {
        videoElement.play().then(() => {
          log('播放命令执行成功', 'info');
        }).catch(e => {
          log(`播放失败: ${e.message}`, 'error');
        });
      }
    }

    function pauseVideo() {
      if (videoElement) {
        videoElement.pause();
      }
    }

    // 页面加载完成后初始化
    window.addEventListener('load', () => {
      log('=== 页面加载完成 ===', 'info');
      log(`flv.js版本: ${flvjs.version}`, 'info');
      log(`浏览器支持: ${flvjs.isSupported() ? '是' : '否'}`, 'info');
      updateDiagnostics();
      
      // 自动测试CORS
      setTimeout(() => {
        testCORS();
      }, 500);
      
      // 自动加载视频
      setTimeout(() => {
        loadVideo();
      }, 1000);
    });

    // 清理
    window.addEventListener('beforeunload', () => {
      if (flvPlayer) {
        flvPlayer.destroy();
      }
    });
  </script>
</body>
</html>
